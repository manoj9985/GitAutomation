package stepDefinition;

import java.time.Duration;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.*;

import io.cucumber.java.en.*;

public class stepDefinitionScenarios {

    static WebDriver driver;

    @Given("I landed on Ecommerce Page")
    public void i_landed_on_ecommerce_page() {
        driver = new ChromeDriver();
        driver.manage().window().maximize();
        System.out.println("Browser Launched");
    }

    @Given("^Logged in with Username and Password$")
    public void Logged_in_with_Username_and_Password() {
        driver.get("https://rahulshettyacademy.com/client");

        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));
        wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("userEmail"))).sendKeys("dihamoj266@gotemv.com");
        driver.findElement(By.id("userPassword")).sendKeys("M@noj998504");
        driver.findElement(By.id("login")).click();

        // üß† Optional: Wait for captcha manually
        try {
            wait.until(ExpectedConditions.urlContains("dashboard"));
        } catch (TimeoutException e) {
            System.out.println("‚ö†Ô∏è Captcha likely present. Please solve it manually to proceed.");
        }
    }

    @When("^I added product to the cart$")
    public void When_I_added_product_to_the_cart() {
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

        WebElement addToCartButton = wait.until(ExpectedConditions.elementToBeClickable(
                By.xpath("(//button[@class='btn w-10 rounded'][normalize-space()='Add To Cart'])[1]")));
        addToCartButton.click();

        // ‚úÖ Scroll into view before clicking cart button
        WebElement cartButton = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.cssSelector(".btn.btn-custom[routerlink='/dashboard/cart']")));

        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", cartButton);
        wait.until(ExpectedConditions.elementToBeClickable(cartButton)).click();
    }

    @And("^Checkout and submit the order$")
    public void And_Checkout_and_submit_the_order() {
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));

        boolean productVisible = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.cssSelector("div.cartSection h3"))).isDisplayed();
        System.out.println("‚úÖ Product visible in cart: " + productVisible);

        WebElement checkoutButton = wait.until(ExpectedConditions.elementToBeClickable(
                By.xpath("//button[contains(text(),'Checkout')]")));

        // Scroll and use JS click to avoid intercept issues
        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", checkoutButton);
        ((JavascriptExecutor) driver).executeScript("arguments[0].click();", checkoutButton);

        wait.until(ExpectedConditions.elementToBeClickable(
                By.xpath("//input[contains(@placeholder, 'Select Country')]"))).sendKeys("India");

        try {
            WebElement countryOption = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("(//button[@type='button'])[2]")));
            ((JavascriptExecutor) driver).executeScript("arguments[0].click();", countryOption);
        } catch (Exception e) {
            System.out.println("‚ö†Ô∏è Country suggestion not clickable, continuing...");
        }

        WebElement submitOrder = wait.until(ExpectedConditions.elementToBeClickable(
                By.xpath("//a[contains(@class,'btnn action__submit')]")));
        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", submitOrder);
        ((JavascriptExecutor) driver).executeScript("arguments[0].click();", submitOrder);
    }



    @Then("^message id displayed in confirmation page$")
    public void message_id_displayed_in_confirmation_page() {
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
        boolean confirmationVisible = wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.cssSelector(".hero-primary"))).isDisplayed();

        System.out.println("‚úÖ Order confirmation message displayed: " + confirmationVisible);
    }
}
